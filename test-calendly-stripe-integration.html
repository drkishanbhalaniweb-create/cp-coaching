<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendly-Stripe Integration Test</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f3f4f8;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: #163b63;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #6b7280;
            margin-bottom: 30px;
        }

        .test-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .test-section h2 {
            color: #163b63;
            margin-bottom: 16px;
            font-size: 1.3rem;
        }

        .test-section h3 {
            color: #1f4f85;
            margin: 16px 0 12px;
            font-size: 1.1rem;
        }

        .test-item {
            padding: 12px;
            margin-bottom: 12px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #d1d5db;
        }

        .test-item.pass {
            border-left-color: #22c55e;
            background: #f0fdf4;
        }

        .test-item.fail {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .test-item.pending {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .status.pass {
            background: #22c55e;
            color: white;
        }

        .status.fail {
            background: #ef4444;
            color: white;
        }

        .status.pending {
            background: #f59e0b;
            color: white;
        }

        button {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            font-size: 0.95rem;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(34, 197, 94, 0.3);
        }

        button.secondary {
            background: linear-gradient(135deg, #163b63, #0f243d);
        }

        button.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .code-block {
            background: #1e293b;
            color: #e5e7eb;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #93c5fd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
        }

        .info-box strong {
            color: #1e40af;
        }

        .checklist {
            list-style: none;
            padding: 0;
        }

        .checklist li {
            padding: 8px 0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .checklist li::before {
            content: "‚òê";
            font-size: 1.2rem;
            color: #6b7280;
        }

        .checklist li.checked::before {
            content: "‚òë";
            color: #22c55e;
        }

        #test-results {
            margin-top: 20px;
        }

        .flow-diagram {
            background: white;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .flow-step {
            display: flex;
            align-items: center;
            margin: 12px 0;
            padding: 12px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .flow-step-number {
            width: 32px;
            height: 32px;
            background: #163b63;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            margin-right: 12px;
            flex-shrink: 0;
        }

        .flow-arrow {
            text-align: center;
            color: #6b7280;
            font-size: 1.5rem;
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Calendly-Stripe Integration Test</h1>
        <p class="subtitle">Comprehensive testing for paid booking flow (Requirements 11.2, 11.3, 11.4, 11.5)</p>

        <!-- Integration Flow -->
        <div class="test-section">
            <h2>üìã Integration Flow</h2>
            <p>This diagram shows how Calendly and Stripe work together for paid bookings:</p>
            
            <div class="flow-diagram">
                <div class="flow-step">
                    <div class="flow-step-number">1</div>
                    <div>
                        <strong>User clicks "Book Session" button</strong>
                        <div style="color: #6b7280; font-size: 0.9rem;">Opens Calendly popup widget</div>
                    </div>
                </div>
                <div class="flow-arrow">‚Üì</div>
                
                <div class="flow-step">
                    <div class="flow-step-number">2</div>
                    <div>
                        <strong>User selects date and time in Calendly</strong>
                        <div style="color: #6b7280; font-size: 0.9rem;">Calendly fires 'date_and_time_selected' event</div>
                    </div>
                </div>
                <div class="flow-arrow">‚Üì</div>
                
                <div class="flow-step">
                    <div class="flow-step-number">3</div>
                    <div>
                        <strong>System detects paid event and initiates payment</strong>
                        <div style="color: #6b7280; font-size: 0.9rem;">Closes Calendly, creates Stripe Checkout Session</div>
                    </div>
                </div>
                <div class="flow-arrow">‚Üì</div>
                
                <div class="flow-step">
                    <div class="flow-step-number">4</div>
                    <div>
                        <strong>User redirected to Stripe Checkout</strong>
                        <div style="color: #6b7280; font-size: 0.9rem;">Enters payment information</div>
                    </div>
                </div>
                <div class="flow-arrow">‚Üì</div>
                
                <div class="flow-step">
                    <div class="flow-step-number">5</div>
                    <div>
                        <strong>Payment processed by Stripe</strong>
                        <div style="color: #6b7280; font-size: 0.9rem;">Success ‚Üí webhook fired | Failure ‚Üí error handling</div>
                    </div>
                </div>
                <div class="flow-arrow">‚Üì</div>
                
                <div class="flow-step">
                    <div class="flow-step-number">6</div>
                    <div>
                        <strong>Webhook confirms booking after payment</strong>
                        <div style="color: #6b7280; font-size: 0.9rem;">checkout.session.completed ‚Üí booking confirmed</div>
                    </div>
                </div>
                <div class="flow-arrow">‚Üì</div>
                
                <div class="flow-step">
                    <div class="flow-step-number">7</div>
                    <div>
                        <strong>User redirected to success page</strong>
                        <div style="color: #6b7280; font-size: 0.9rem;">Shows booking confirmation and payment receipt</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Checklist -->
        <div class="test-section">
            <h2>‚úÖ Test Checklist</h2>
            <p>Manual testing steps to verify the integration:</p>
            
            <h3>Requirement 11.2: Paid meeting booking triggers payment</h3>
            <ul class="checklist">
                <li>Open the landing page (index.html)</li>
                <li>Click "Book Your Session" button</li>
                <li>Verify Calendly popup opens</li>
                <li>Select a date and time</li>
                <li>Verify Calendly popup closes automatically</li>
                <li>Verify loading message appears: "Processing Your Booking"</li>
                <li>Verify redirect to Stripe Checkout page</li>
            </ul>

            <h3>Requirement 11.3: Booking confirmation synchronized with payment</h3>
            <ul class="checklist">
                <li>Complete payment with test card: 4242 4242 4242 4242</li>
                <li>Verify redirect to success.html page</li>
                <li>Verify success page shows "Booking Confirmed!"</li>
                <li>Verify session ID is displayed</li>
                <li>Check webhook logs for checkout.session.completed event</li>
                <li>Verify webhook logs show "Booking confirmed after successful payment"</li>
            </ul>

            <h3>Requirement 11.4: Payment failure prevents booking</h3>
            <ul class="checklist">
                <li>Start booking flow again</li>
                <li>Use declined test card: 4000 0000 0000 0002</li>
                <li>Verify payment fails</li>
                <li>Verify user is NOT redirected to success page</li>
                <li>Check webhook logs for payment_intent.payment_failed event</li>
                <li>Verify webhook logs show "Payment failure prevents booking confirmation"</li>
                <li>Verify no booking confirmation is sent</li>
            </ul>

            <h3>Requirement 11.5: Complete flow without leaving site</h3>
            <ul class="checklist">
                <li>Complete entire flow from start to finish</li>
                <li>Verify smooth transitions between steps</li>
                <li>Verify no broken links or errors</li>
                <li>Verify user experience is seamless</li>
            </ul>
        </div>

        <!-- Code Implementation -->
        <div class="test-section">
            <h2>üíª Implementation Details</h2>
            
            <h3>1. CalendlyHandler - Payment Flow Initiation</h3>
            <p>The CalendlyHandler now listens for date/time selection and initiates payment:</p>
            <div class="code-block">
// In setupEventListener()
if (eventName === 'calendly.date_and_time_selected') {
  if (this.isPaidEvent()) {
    this.initiatePaymentFlow(e.data);
  }
}

// initiatePaymentFlow() method
async initiatePaymentFlow(eventData) {
  // Close Calendly popup
  Calendly.closePopupWidget();
  
  // Show loading message
  this.showPaymentLoadingMessage();
  
  // Create Stripe checkout session
  const sessionData = await stripePaymentHandler
    .createCheckoutSession({ email, calendlyEventUri, calendlyInviteeUri });
  
  // Redirect to Stripe Checkout
  window.location.href = sessionData.url;
}
            </div>

            <h3>2. Webhook Handler - Booking Confirmation</h3>
            <p>The webhook confirms bookings only after successful payment:</p>
            <div class="code-block">
case 'checkout.session.completed':
  console.log('Payment successful - Booking confirmed');
  // Booking is now valid and confirmed
  // TODO: Send confirmation email, update database
  break;

case 'payment_intent.payment_failed':
  console.log('Payment failure prevents booking confirmation');
  // IMPORTANT: Do NOT confirm booking without payment
  // TODO: Cancel Calendly booking if created
  break;
            </div>

            <h3>3. Success Page - Confirmation Display</h3>
            <p>The success page shows booking confirmation after payment:</p>
            <div class="code-block">
// success.html displays:
- "Booking Confirmed!" heading
- Payment confirmation with session ID
- Next steps for the user
- Contact information for support
            </div>
        </div>

        <!-- Test Stripe Cards -->
        <div class="test-section">
            <h2>üí≥ Stripe Test Cards</h2>
            <p>Use these test cards to verify different payment scenarios:</p>
            
            <div class="info-box">
                <strong>‚úÖ Successful Payment:</strong><br>
                Card: 4242 4242 4242 4242<br>
                Expiry: Any future date<br>
                CVC: Any 3 digits<br>
                ZIP: Any 5 digits
            </div>

            <div class="info-box" style="background: #fef2f2; border-color: #fca5a5;">
                <strong style="color: #991b1b;">‚ùå Declined Payment:</strong><br>
                Card: 4000 0000 0000 0002<br>
                Expiry: Any future date<br>
                CVC: Any 3 digits<br>
                ZIP: Any 5 digits
            </div>

            <div class="info-box" style="background: #fffbeb; border-color: #fcd34d;">
                <strong style="color: #92400e;">‚ö†Ô∏è Requires Authentication:</strong><br>
                Card: 4000 0025 0000 3155<br>
                Expiry: Any future date<br>
                CVC: Any 3 digits<br>
                ZIP: Any 5 digits
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="test-section">
            <h2>üöÄ Quick Actions</h2>
            <button onclick="window.open('/index.html', '_blank')">Open Landing Page</button>
            <button onclick="window.open('/success.html?session_id=test_session_123', '_blank')" class="secondary">
                Open Success Page (Test)
            </button>
            <button onclick="checkWebhookLogs()" class="secondary">Check Webhook Logs</button>
            <button onclick="clearTestData()" class="danger">Clear Test Data</button>
        </div>

        <!-- Test Results -->
        <div class="test-section">
            <h2>üìä Automated Checks</h2>
            <button onclick="runAutomatedTests()">Run Automated Tests</button>
            <div id="test-results"></div>
        </div>

        <!-- Environment Check -->
        <div class="test-section">
            <h2>üîß Environment Check</h2>
            <div id="env-check">
                <p>Checking environment configuration...</p>
            </div>
        </div>
    </div>

    <script>
        // Run environment check on load
        window.addEventListener('load', checkEnvironment);

        function checkEnvironment() {
            const envCheck = document.getElementById('env-check');
            const checks = [];

            // Check if running locally or on server
            const isLocal = window.location.hostname === 'localhost' || 
                           window.location.hostname === '127.0.0.1';
            checks.push({
                name: 'Environment',
                status: isLocal ? 'Local Development' : 'Production/Staging',
                pass: true
            });

            // Check if Stripe.js would be loaded
            checks.push({
                name: 'Stripe.js Script',
                status: 'Should be loaded from CDN in main page',
                pass: true
            });

            // Check if Calendly script would be loaded
            checks.push({
                name: 'Calendly Script',
                status: 'Should be loaded from CDN in main page',
                pass: true
            });

            // Display results
            let html = '<div style="margin-top: 16px;">';
            checks.forEach(check => {
                const statusClass = check.pass ? 'pass' : 'fail';
                html += `
                    <div class="test-item ${statusClass}">
                        <strong>${check.name}:</strong> ${check.status}
                        <span class="status ${statusClass}">${check.pass ? 'OK' : 'FAIL'}</span>
                    </div>
                `;
            });
            html += '</div>';
            envCheck.innerHTML = html;
        }

        function runAutomatedTests() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p style="margin-top: 16px;">Running tests...</p>';

            const tests = [
                {
                    name: 'CalendlyHandler class exists in index.html',
                    test: () => true, // Would need to check actual file
                    status: 'pending'
                },
                {
                    name: 'StripePaymentHandler class exists in index.html',
                    test: () => true,
                    status: 'pending'
                },
                {
                    name: 'Webhook handler processes checkout.session.completed',
                    test: () => true,
                    status: 'pending'
                },
                {
                    name: 'Webhook handler processes payment_intent.payment_failed',
                    test: () => true,
                    status: 'pending'
                },
                {
                    name: 'Success page displays session ID',
                    test: () => true,
                    status: 'pending'
                }
            ];

            let html = '<div style="margin-top: 16px;">';
            html += '<p><strong>Note:</strong> These are implementation checks. Manual testing required for full verification.</p>';
            tests.forEach(test => {
                html += `
                    <div class="test-item ${test.status}">
                        <strong>${test.name}</strong>
                        <span class="status ${test.status}">${test.status.toUpperCase()}</span>
                    </div>
                `;
            });
            html += '</div>';
            resultsDiv.innerHTML = html;
        }

        function checkWebhookLogs() {
            alert('To check webhook logs:\n\n' +
                  '1. Open Vercel Dashboard\n' +
                  '2. Go to your project\n' +
                  '3. Click "Functions" tab\n' +
                  '4. Select "webhook.js"\n' +
                  '5. View logs for recent events\n\n' +
                  'Or use Stripe Dashboard:\n' +
                  '1. Go to Developers > Webhooks\n' +
                  '2. Click on your webhook endpoint\n' +
                  '3. View recent events and responses');
        }

        function clearTestData() {
            if (confirm('Clear test data from session storage?')) {
                sessionStorage.removeItem('pendingBookingSessionId');
                sessionStorage.removeItem('pendingBookingData');
                alert('Test data cleared!');
            }
        }

        // Log page load
        console.log('Calendly-Stripe Integration Test Page Loaded');
        console.log('Use this page to verify the complete booking-to-payment flow');
    </script>
</body>
</html>
